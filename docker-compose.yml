
services:
  ytdlp-api:
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.11-slim
        WORKDIR /app
        RUN apt-get update && apt-get install -y \
            ffmpeg \
            && rm -rf /var/lib/apt/lists/*
        COPY requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt
        COPY app.py .
        EXPOSE 30022
        ENV PYTHONUNBUFFERED=1
        CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "30022"]
    ports:
      - "30022:30022"
    networks:
      - ytdlpapi
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:30022/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  ytdlpapi:
    driver: bridge